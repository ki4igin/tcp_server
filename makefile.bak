###############################################################################
# Main application file name
###############################################################################
TARGET = $(notdir $(shell pwd))


###############################################################################
# Build path
###############################################################################
BUILD_DIR := build


###############################################################################
# Source
###############################################################################
# C includes
C_INCLUDES:= $(shell find src -type d)

# C sources
C_SOURCES := $(wildcard $(addsuffix /*.c, $(C_INCLUDES)))


###############################################################################
# Compilers and Utilities binaries
###############################################################################
CC := gcc


###############################################################################
# CFLAGS
###############################################################################

# Compile gcc flags
CFLAGS += -std=gnu11
CFLAGS += -Winline -Wall -Wextra #-pedantic #-Werror 
CFLAGS += -MMD -MP

###############################################################################
# build the application
###############################################################################
# list of objects
OBJECTS := $(addprefix $(BUILD_DIR)/, $(notdir $(C_SOURCES:.c=.o)))
vpath %.c $(sort $(C_INCLUDES))

# build
all: info $(BUILD_DIR)/$(TARGET)
	cp $(BUILD_DIR)/$(TARGET) ./
	
$(BUILD_DIR)/$(TARGET): $(OBJECTS) 	
	$(CC) $(OBJECTS) $(LFLAGS) -o $@
	 
$(BUILD_DIR)/%.o: %.c | $(BUILD_DIR)
	@echo $< " "
	$(CC) -c $< $(addprefix -I, $(C_INCLUDES)) \
	$(addprefix -D, $(DEFINES)) $(CFLAGS) -o $@	

$(BUILD_DIR): info
	mkdir -p $@

###############################################################################
# clean up
###############################################################################
.PHONY: clean
clean:
	@echo -rm -fR $(BUILD_DIR)
	-rm -fR $(BUILD_DIR)

###############################################################################
# Info
###############################################################################
info:
	@echo -e $(COLOR_GREEN)"Compiler version:"$(COLOR_NC)
	$(CC) --version

###############################################################################
# dependencies
###############################################################################
-include $(wildcard $(BUILD_DIR)/*.d)
###############################################################################

###############################################################################
# Colors for echo -e
###############################################################################
COLOR_RED		= "\033[0;31m"
COLOR_GREEN		= "\033[0;32m"
COLOR_YELLOW	= "\033[0;33m"
COLOR_NC		= "\033[0m"
###############################################################################